# Интерактивный скрипт резервного копирования и восстановления Bakupz

**!!! USE AT YOUR OWN  RISK !!!**

Это репозиторий для **Интерактивного скрипта резервного копирования и восстановления Bakupz**, надежного решения на Bash, предназначенного для резервного копирования и восстановления содержимого рабочей директории, специально адаптированного для сред с использованием Docker и виртуальных окружений Python (venv).

-----

## Содержание

  - [Почему этот скрипт?](#почему-этот-скрипт)
  - [Функции](#функции)
  - [Предварительные требования](#предварительные-требования)
  - [Установка](#установка)
  - [Использование](#использование)
      - [Интерактивный режим](#интерактивный-режим)
      - [Неинтерактивный режим (для Cron)](#неинтерактивный-режим-для-cron)
  - [Детали процесса резервного копирования](#детали-процесса-резервного-копирования)
  - [Детали процесса восстановления](#детали-процесса-восстановления)
  - [Конфигурация](#конфигурация)
  - [Зависимости](#зависимости)
  - [Лицензия](#лицензия)

-----

## Почему этот скрипт?

В современном разработке и развертывании приложений, особенно с контейнеризацией и микросервисами, простая команда `tar -czf` часто недостаточна. Этот скрипт решает сложность резервного копирования директории проекта, которая содержит:

1.  **Тома Docker:** Стандартные инструменты резервного копирования часто пропускают данные внутри томов Docker, которые могут быть критически важными. Этот скрипт специально находит и архивирует локальные тома Docker, связанные с проектами.
2.  **Системные конфигурации:** Ключевые настройки служб, такие как правила брандмауэра (`ufw`) или конфигурации демона Docker (`daemon.json`), должны сохраняться вместе с данными проекта для полного и работоспособного восстановления.
3.  **Виртуальные окружения Python (Venv):** Хотя обычно не следует архивировать полную директорию venv, скрипт интегрирует интеллектуальный механизм восстановления для воссоздания и заполнения виртуальных окружений на основе `requirements.txt`, обеспечивая готовую к запуску настройку после восстановления.
4.  **Безопасность и целостность:** Использует строгие настройки оболочки (`set -euo pipefail`), применяет `sha256sum` для проверки целостности содержимого и добавляет уникальную сигнатуру в начало архива, делая файл резервной копии самопроверяемым и устойчивым к незаметным повреждениям.
5.  **Поддержка интерактивности и автоматизации:** Предлагает удобное интерактивное меню для ручных операций, при этом полностью поддерживая неинтерактивный режим, что делает его идеальным для запланированных задач через `cron`.

Вкратце, он предоставляет **целостный, самодостаточный и проверенный снимок системы**, а не просто дамп файлов.

-----

## Функции

  * **Проверки целостности системы:** Использует `sha256sum` и кастомную сигнатуру для сквозной проверки архива как при создании, так и при восстановлении.
  * **Осведомленность о Docker:** Собирает метаданные Docker (сети, тома) и использует `rsync` для инкрементального резервного копирования **локальных** томов Docker, минимизируя размер и время резервной копии.
  * **Резервное копирование конфигураций:** Архивирует кастомные системные конфигурации (например, UFW, настройки демона Docker), указанные в `CUSTOM_CONFIG_PATHS`.
  * **Восстановление Venv:** Предлагает интеллектуальное восстановление виртуальных окружений Python после восстановления.
  * **Режим Dry-Run:** Позволяет предварительно проверить пути файлов и настройки без создания финального архива.
  * **Управление логами:** Автоматически ротирует файлы логов для предотвращения чрезмерного использования диска (`MAX_LOGS`).
  * **Требование root:** Обеспечивает выполнение операций с необходимыми привилегиями для доступа к системе и Docker.

-----

## Предварительные требования

  * Linux-окружение (протестировано в основном на производных от Debian/Ubuntu, но должно работать на любой системе со стандартными утилитами GNU).
  * Привилегии root (`sudo`).
  * Следующие системные зависимости (скрипт пытается установить отсутствующие автоматически на системах с `apt` или `yum`):
      * `docker`, `jq`, `rsync`, `xz`, `sha256sum`, `tar`, `mktemp`, `find`, `awk`, `sort`, `xargs`, `pv`, `du`.

-----

## Установка

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/srose69/bakupz.git
    cd bakupz
    ```
2.  **Сделайте скрипт исполняемым:**
    ```bash
    chmod +x backup.sh
    ```
3.  **Запустите скрипт от root:**
    ```bash
    sudo ./backup.sh
    ```

-----

## Использование

Скрипт должен запускаться из директории, содержащей проекты и/или файлы Docker Compose, которые вы хотите архивировать или восстановить, поскольку он использует текущую рабочую директорию (`CWD`) в качестве базы.

### Интерактивный режим

Просто запустите скрипт с `sudo`:

```bash
sudo ./backup.sh
```

Появится меню:

```
========================================
    Bakupz Интерактивный Backup-менеджер
========================================
1. Создать резервную копию системы
2. Восстановить систему из резервной копии
3. Просмотреть логи
4. Выход
========================================
Выберите действие (1-4):
```

Вы будете запрошены на выбор проектов и подтверждение для критических действий, таких как восстановление.

### Неинтерактивный режим (для Cron)

Этот режим предназначен для запланированных задач и требует действия и соответствующих аргументов.

#### Резервное копирование

Для резервного копирования конкретных проектов (`project1`, `project2`) без вмешательства пользователя:

```bash
sudo ./backup.sh --non-interactive backup project1 project2
```

Для резервного копирования всех обнаруженных проектов:

```bash
sudo ./backup.sh --non-interactive backup all
```

#### Восстановление

Для восстановления системы из конкретного файла архива:

```bash
sudo ./backup.sh --non-interactive restore /path/to/archive.srvbak
```

**Примечание:** Неинтерактивное восстановление будет продолжаться без финального запроса подтверждения, поэтому используйте с осторожностью.

-----

## Детали процесса резервного копирования

Функция `backup_system` выполняет следующие шаги:

1.  **Проверка зависимостей и ротация логов:** Подтверждает наличие всех необходимых утилит и очищает старые логи.
2.  **Сбор метаданных Docker:** Проверяет все сети и тома Docker, сохраняя их конфигурации в `docker_metadata.json`.
3.  **Архивирование томов Docker (инкрементальное):**
      * Итерация по локальным томам, перечисленным в метаданных.
      * Использование `rsync -aHAX --delete` для копирования содержимого тома в временную директорию.
      * Архивирование скопированного тома с помощью `tar` и сжатие с `xz`.
      * Включение индикатора прогресса с помощью `pv`, если доступен.
      * Вычисление хеша для архива тома и его сохранение.
4.  **Архивирование системных конфигураций:** Копирование системных файлов, перечисленных в `CUSTOM_CONFIG_PATHS` (например, `/etc/ufw`), и архивирование их в `configs.tar.xz`.
5.  **Копирование проектов:** Использование `rsync` для копирования выбранных проектов во временную директорию.
6.  **Финализация:**
      * Создание основного архива (`volumes`, `configs`, `projects`, `hashes`) с помощью `tar -cJf`.
      * Вычисление хеша содержимого.
      * Генерация уникальной, проверяемой сигнатуры на основе хеша содержимого и добавление ее в начало файла архива.
      * Переименование финального архива для включения префиксов хешей содержимого и финального файла для быстрой проверки: `vxpx_full_backup_YYYY-MM-DD_HH-MM-SS_H-xxxxxxxx_F-xxxxxxxx.srvbak`.

-----

## Детали процесса восстановления

Функция `restore_system` представляет собой многоэтапную процедуру для возврата состояния системы:

1.  **Выбор архива и проверка:**
      * Позволяет интерактивную или неинтерактивную спецификацию пути архива.
      * Выполняет **три** уровня проверки целостности:
          * Проверка финального хеша файла.
          * Проверка сигнатуры (обеспечение того, что это валидный бэкап VXPX).
          * Проверка хеша содержимого (проверка основного тела архива).
2.  **Остановка служб:** Все службы Docker Compose в базовой директории gracefully останавливаются (`docker-compose down`).
3.  **Восстановление файлов:**
      * Основной архив извлекается во временную директорию.
      * Файлы проектов копируются обратно в `BASE_DIR` с помощью `rsync -aHAX`.
4.  **Восстановление системных конфигураций:**
      * Проверка целостности `configs.tar.xz` внутри бэкапа.
      * Извлечение системных конфигураций в корневую файловую систему (`/`).
      * Перезагрузка правил UFW и перезапуск службы Docker.
5.  **Восстановление сетей и томов Docker:**
      * Сети воссоздаются на основе сохраненных метаданных, если они не существуют.
      * Тома создаются, и их архивированные данные восстанавливаются с использованием временного контейнера Docker для монтирования тома, обеспечивая правильные разрешения и владельцев.
6.  **Воссоздание Venv:** Запрашивает пользователя (или пропускает в неинтерактивном режиме) на проверку `requirements.txt` в проектах и автоматически воссоздает и устанавливает виртуальные окружения Python.
7.  **Запуск служб:** Все службы Docker Compose запускаются (`docker-compose up -d`).

-----

## Конфигурация

Ключевые переменные, настраиваемые в верхней части скрипта `backup.sh`:

| Переменная | Значение по умолчанию | Описание |
| :--- | :--- | :--- |
| `DEFAULT_LANG` | `"RU"` | Язык вывода скрипта (`RU` или `EN`). |
| `MAX_LOGS` | `10` | Максимальное количество файлов логов для хранения перед ротацией. |
| `XZ_COMPRESSION_LEVEL` | `"-3"` | Уровень сжатия для XZ (например, `-9` для максимального сжатия). |
| `RSYNC_OPTS` | `"-aHAX --delete"` | Опции для rsync (Архив, Жесткие ссылки, ACL, Расширенные атрибуты и удаление лишних файлов в приемнике). |
| `CUSTOM_CONFIG_PATHS` | `("/etc/ufw", "/etc/docker/daemon.json")` | Массив критических системных директорий/файлов для включения в резервную копию. |

-----

## Зависимости

Скрипт полагается на ряд распространенных утилит Linux. Функция `check_dependencies` пытается установить отсутствующие инструменты автоматически с помощью `apt-get` или `yum`.

  * `docker`: Для управления контейнерами и томами.
  * `jq`: Для обработки JSON (метаданные Docker).
  * `rsync`: Для эффективного копирования файлов (тома и проекты).
  * `xz`, `tar`: Для сжатия и архивирования.
  * `sha256sum`: Для вычисления хешей файлов.
  * `pv`: (Опционально) Для отображения прогресса во время архивирования томов.
  * `python3-venv`: (Опционально) Требуется для создания Venv во время восстановления.

-----

## Лицензия

Этот проект лицензирован под GNU GPLv3 License - см. файл `LICENSE` для деталей
```
